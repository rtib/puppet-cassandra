<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>
  File: README
  
    &mdash; Documentation by YARD 0.9.36
  
</title>

  <link rel="stylesheet" href="css/style.css" type="text/css" />

  <link rel="stylesheet" href="css/common.css" type="text/css" />

<script type="text/javascript">
  pathId = "";
  relpath = '';
</script>


  <script type="text/javascript" charset="utf-8" src="js/jquery.js"></script>

  <script type="text/javascript" charset="utf-8" src="js/app.js"></script>


  </head>
  <body>
    <div class="nav_wrap">
      <iframe id="nav" src="file_list.html?1"></iframe>
      <div id="resizer"></div>
    </div>

    <div id="main" tabindex="-1">
      <div id="header">
        <div id="menu">
  
    <a href="_index.html">Index</a> &raquo; 
    <span class="title">File: README</span>
  
</div>

        <div id="search">
  
    <a class="full_list_link" id="puppet_class_list_link"
        href="puppet_class_list.html">

        <svg width="24" height="24">
          <rect x="0" y="4" width="24" height="4" rx="1" ry="1"></rect>
          <rect x="0" y="12" width="24" height="4" rx="1" ry="1"></rect>
          <rect x="0" y="20" width="24" height="4" rx="1" ry="1"></rect>
        </svg>
    </a>
  
</div>
        <div class="clear"></div>
      </div>

      <div id="content"><div id='filecontents'>
<h1 id="label-cassandra">cassandra</h1>

<h2 id="label-Project+status">Project status</h2>

<p>GitHub: <a href="https://github.com/rtib/puppet-cassandra/issues"><img src="https://img.shields.io/github/issues/rtib/puppet-cassandra.svg"></a> <a href="https://github.com/rtib/puppet-cassandra/releases"><img src="https://img.shields.io/github/commit-activity/y/rtib/puppet-cassandra"></a> <a href="https://github.com/rtib/puppet-cassandra/releases"><img src="https://img.shields.io/github/last-commit/rtib/puppet-cassandra"></a></p>

<p>Nightly Workflows: <a href="https://github.com/rtib/puppet-cassandra/actions/workflows/ci.yaml"><img src="https://github.com/rtib/puppet-cassandra/actions/workflows/ci.yaml/badge.svg"></a></p>

<p>Puppet Forge: <img src="https://img.shields.io/puppetforge/pdk-version/trepasi/cassandra.svg"> <a href="https://forge.puppet.com/trepasi/cassandra"><img src="https://img.shields.io/puppetforge/v/trepasi/cassandra.svg"></a></p>

<h2 id="label-Table+of+Contents">Table of Contents</h2>
<!-- @import "[TOC]" depthFrom=2 depthTo=3 orderedList=false --><!-- code_chunk_output --><ul><li>
<p><a href="#cassandra">cassandra</a></p>
</li><li>
<p><a href="#project-status">Project status</a></p>
</li><li>
<p><a href="#table-of-contents">Table of Contents</a></p>
</li><li>
<p><a href="#description">Description</a></p>
</li><li>
<p><a href="#setup">Setup</a></p>
<ul><li>
<p><a href="#what-cassandra-affects">What cassandra affects</a></p>
</li><li>
<p><a href="#setup-requirements">Setup Requirements</a></p>
</li><li>
<p><a href="#beginning-with-cassandra">Beginning with cassandra</a></p>
</li></ul>
</li><li>
<p><a href="#usage">Usage</a></p>
<ul><li>
<p><a href="#installation-versions">Installation versions</a></p>
</li><li>
<p><a href="#main-node-configuration">Main node configuration</a></p>
</li><li>
<p><a href="#setting-up-initial_token">Setting up initial_token</a></p>
</li><li>
<p><a href="#rack-and-dc-settings">Rack and DC settings</a></p>
</li><li>
<p><a href="#topology-settings">Topology settings</a></p>
</li><li>
<p><a href="#setting-the-runtime-environment">Setting the runtime environment</a></p>
</li><li>
<p><a href="#environment-variables">Environment variables</a></p>
</li><li>
<p><a href="#jvm-options">JVM options</a></p>
</li><li>
<p><a href="#java-runtime-settings">Java runtime settings</a></p>
</li><li>
<p><a href="#java-garbage-collection-settings">Java garbage collection settings</a></p>
</li><li>
<p><a href="#jvm-option-sets">JVM option sets</a></p>
</li><li>
<p><a href="#jvm-options-for-cassandra-3x">JVM options for Cassandra 3.x</a></p>
</li><li>
<p><a href="#cassandra-40-jvm-setup">Cassandra 4.0 JVM setup</a></p>
</li></ul>
</li><li>
<p><a href="#reference">Reference</a></p>
</li><li>
<p><a href="#limitations">Limitations</a></p>
</li><li>
<p><a href="#development">Development</a></p>
</li></ul>
<!-- /code_chunk_output -->
<h2 id="label-Description">Description</h2>

<p>This module enables Puppet to install, configure and run <a href="https://cassandra.apache.org/">Apache Cassandra</a> nodes. As a spin-off of several years of experience we collected in running Cassandra in a production environment, using Puppet to maintain the configuration of the nodes. During its evolution the module has proven to be useful for Cassandra versions ranging from early 1.1, over many 2.x, 3.0, 3.11 to latest 5.0 releases and multiple distributions, e.g. DSE, Apache and other. Efforts are taken to keep the generally available Apache open-source releases supported.</p>

<p>Leveraging the declarative nature of Puppet DSL, Cassandra configuration is considered a declarative description of the desired state and will be ensured in the node configuration. Configuration values not declared in the manifest will be kept untouched by this module.</p>

<p>Conceptualized to fit into a roles/profiles design pattern, this module keeps a strong focus on the topic of Cassandra node configuration disregarding many aspects bound to the use-case and the infrastructure environment.</p>

<h2 id="label-Setup">Setup</h2>

<h3 id="label-What+cassandra+affects">What cassandra affects</h3>

<p>This module affects the following component:</p>
<ul><li>
<p>Install the Packages <code>cassandra</code> and <code>cassandra-tools</code>.</p>
</li><li>
<p>It takes control over the file <code>.cassandra.in.sh</code> located in Cassandra user’s home directory.</p>
</li><li>
<p>It takes control over <code>cassandra-rackdc.properties</code> and <code>cassandra-topology.properties</code></p>
</li><li>
<p>Optionally it can take control over the <code>jvm.options</code> file and its successors for multiple Java versions and variants, used to configure Java parameters.</p>
</li><li>
<p>It manages the content of the <code>cassandra.yaml</code> by merging a configuration hash to the file as it is found on the node, i.e. installed from the package.</p>
</li></ul>

<p>A bit more important to know is that it does not control the contents of <code>cassandra-env.sh</code> and many other files, which might lead to conflicts during package updates.</p>

<h3 id="label-Setup+Requirements">Setup Requirements</h3>

<p>Installation and running of Cassandra will require some other settings not covered by this module, e.g.:</p>
<ul><li>
<p>access to a package repository providing the necessery packages for your operating system distribution</p>
</li><li>
<p>installation of a suitable Java runtime environment</p>
</li><li>
<p>setup of a proper clock synchronisation, e.g. NTP</p>
</li><li>
<p>configuration of additional settings, e.g. kernel parameter, firewall, etc.</p>
</li></ul>

<h3 id="label-Beginning+with+cassandra">Beginning with cassandra</h3>

<p>Include the module to your node manifests (or your role or profile module):</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_contain'>contain</span> <span class='id identifier rubyid_cassandra'>cassandra</span>
</code></pre>

<h2 id="label-Usage">Usage</h2>

<p>Once included in the node manifest the module can be configured via Hiera.</p>

<h3 id="label-Installation+versions">Installation versions</h3>

<p>By default the latest available version of <code>cassandra</code> and <code>cassandra-tools</code> packages will be installed. The default settings will prevent autoatic upgrades.</p>

<p>If you want Puppet to install a specific version, e.g. 4.0.0, just add the following parameter to your Hiera DB:</p>

<pre class="code ruby"><code class="ruby">cassandra::cassandra_ensure: 4.0.0
</code></pre>

<p>The version ensurement of the tools package defaults to <code>cassandra::cassandra_ensure</code> but can be set differently, e.g.:</p>

<pre class="code ruby"><code class="ruby">cassandra::tools_ensure: latest
</code></pre>

<p>If you don’t want to install the tools package, you can set:</p>

<pre class="code ruby"><code class="ruby">cassandra::tools_ensure: absent
</code></pre>

<p>In the case, your package name differs from default Apache releases you may change <code>cassandra_package</code> and/or <code>tools_package</code> settings, e.g.</p>

<pre class="code ruby"><code class="ruby">cassandra::cassandra_package: dsc22
</code></pre>

<h3 id="label-Main+node+configuration">Main node configuration</h3>

<p>The module provides you access to the main configuration file, the <code>cassandra.yaml</code>, through the configuration parameter <code>config</code>. This may contain a hash resembling the structure of the <code>cassandra.yaml</code>, which will be merged to the current content of the <code>cassandra.yaml</code> file on the node. This merge will only happen on the node itself.</p>

<p>Thus the <code>config</code> parameter should contain only those settings you want to have non-default, i.e. want to change on the node. Keep in mind, that the structure of this hash must fit to the structure of <code>cassandra.yaml</code>, e.g.</p>

<pre class="code ruby"><code class="ruby">cassandra::config:
  cluster_name: Example Cassandra cluster
  endpoint_snitch: PropertyFileSnitch
  seed_provider:
    - class_name: org.apache.cassandra.locator.SimpleSeedProvider
      parameters:
        - seeds: 10.0.0.1,10.0.1.1
  listen_address: &quot;%{facts.networking.ip}&quot;
</code></pre>

<p>As seen for <code>listen_address</code> in the example, you can use Hiera interpolation to access Facts to setup the Cassandra node.</p>

<p>For deeper understanding of this merge procedure refer to the <a href="https://forge.puppet.com/cataphract/yaml_settings">cataphract/yaml_settings</a> module, which is used to merge the <code>config</code> hash with the <code>cassandra.yaml</code> on the node.</p>

<h4 id="label-Setting+up+initial_token">Setting up initial_token</h4>

<p>If your Cassandra setup relies on the setting of <code>initial_token</code> within <code>cassandra.yaml</code>, the module is providing a sophisticated feature. You may set the <code>initial_tokens</code> parameter containing a hash mapping the initial token for each node by a node key. The module will lookup the initial_token for each node by the configured <code>node_key</code> and set the <code>initial_token</code> within the config hash. If there is no entry for a node found, an error is raised which stops the Puppet agent on that node. Example:</p>

<pre class="code ruby"><code class="ruby">cassandra::initial_tokens:
  node01.server.lan: &#39;0&#39;
  node02.server.lan: &#39;56713727820156410577229101238628035242&#39;
  node03.server.lan: &#39;113427455640312821154458202477256070484&#39;
</code></pre>

<p>The <code>node_key</code> parameter, which defaults to <code>$facts[&#39;networking&#39;][&#39;fqdn&#39;]</code> can be changed if you want to map the initial_token by some other ID.</p>

<h3 id="label-Rack+and+DC+settings">Rack and DC settings</h3>

<p>When using <code>GossipingPropertyFileSnitch</code> class for endpoint snitch your cluster, you can manage the <code>cassandra-rackdc.properties</code> file through the <code>rackdc</code> parameter of this module.</p>

<pre class="code ruby"><code class="ruby">cassandra::rackdc:
  dc: dc1
  rack: rackA
</code></pre>

<p>Optionally parameters <code>prefer_local</code> and <code>dc_suffix</code> are also accepted in the <code>rackdc</code> hash.</p>

<h3 id="label-Topology+settings">Topology settings</h3>

<p>Using enpoint snitch classes <code>PropertyFileSnitch</code> or <code>GossipingPropertyFileSnitch</code>, you might want to control the contents of <code>cassandra-topology.properties</code> file. This is enabled through the <code>topology</code> parameter of this module. Containing a multi-leveld hash mapping arrays of your nodes to the racks and the racks to the datacenters. For example:</p>

<pre class="code ruby"><code class="ruby">cassandra::topology:
  dc1:
    rackA:
    - 10.0.0.1
    - 10.0.0.2
    rackB:
    - 10.0.0.3
    - 10.0.0.4
  dc2:
    rackA:
    - 10.0.1.1
    - 10.0.1.2
    rackB:
    - 10.0.1.3
    - 10.0.1.4
</code></pre>

<p>This will end up in a <code>cassandra-topology.properties</code> file containing:</p>

<pre class="code ruby"><code class="ruby">10.0.0.1=dc1:rackA
10.0.0.2=dc1:rackA
10.0.0.3=dc1:rackB
10.0.0.4=dc1:rackB
10.0.1.1=dc2:rackA
10.0.1.2=dc2:rackA
10.0.1.3=dc2:rackB
10.0.1.4=dc2:rackB
</code></pre>

<p>Note #1: leaving the <code>topology</code> parameter <code>undef</code> (which is default), the module will remove the <code>cassandra-topology.properties</code> file from your nodes. This is intended behaviour to support the migration from <code>PropertyFileSnitch</code> to <code>GossipingPropertyFileSnitch</code>.</p>

<p>Note #2: while many configuration changes will notify the service to restart, this is suppressed in the module on updates to the <code>cassandra-topology.properties</code> file. Changes made to the topology won’t bump the Cassandra node, because both snitch classes using this file are reloading it in runtime to read its updated content.</p>

<h3 id="label-Setting+the+runtime+environment">Setting the runtime environment</h3>

<p>The module provides a variety of settings to runtime environment and the Java VM.</p>

<h4 id="label-Environment+variables">Environment variables</h4>

<p>The defined type <code>cassandra::environment::variable</code> can be used to created variables in the Cassandra process’s environment. These typically contain <code>MAX_HEAP_SIZE</code>, <code>HEAP_NEWSIZE</code>, <code>JAVA_HOME</code>, <code>LOCAL_JMX</code> and other Cassandra specific variables.</p>

<p>Using the <code>environment</code> parameter will create <code>cassandra::environment::variable</code> instances, e.g.:</p>

<pre class="code ruby"><code class="ruby">cassandra::environment:
  MAX_HEAP_SIZE: 8G
  HEAP_NEWSIZE: 2G
</code></pre>

<h4 id="label-JVM+options">JVM options</h4>

<p>The defined type <code>cassandra::environment::jvm_option</code> add options to the JVM Cassandra is running on.</p>

<p>Using the <code>jvm_options</code> parameter will create instances of <code>cassandra::environment::jvm_option</code>, e.g.:</p>

<pre class="code ruby"><code class="ruby">cassandra::jvm_options:
  - verbose:gc
  - server
</code></pre>

<h4 id="label-Java+runtime+settings">Java runtime settings</h4>

<p>Within the <code>cassandra::java</code> namespace there are components allowing to setup:</p>
<ul><li>
<p>Java agents through defined type <code>cassandra::java::agent</code></p>
</li><li>
<p>Properties through defined type <code>cassandra::java::property</code></p>
</li><li>
<p>runtime options through defined type <code>cassandra::java::runtimeoption</code></p>
</li><li>
<p>advanced runtime options through defined type <code>cassandra::java::advancedruntimeoption</code></p>
</li><li>
<p>garbage collector settings through class <code>cassandra::java::gc</code></p>
</li></ul>

<p>Using the <code>java</code> property will create instances of the above. E.g.:</p>

<pre class="code ruby"><code class="ruby">cassandra::java:
  properties:
    cassandra.consistent.rangemovement: false
    cassandra.replace_address: 10.0.0.2
  agents:
    jmx_prometheus_javaagent.jar: 8080:config.yaml
  runtime_options:
    check: jni
  adv_runtime_options:
    LargePageSizeInBytes: 2m
    UseLargePages: true
    AlwaysPreTouch: true
</code></pre>

<h3 id="label-Java+garbage+collection+settings">Java garbage collection settings</h3>

<p><strong>Deprication notice:</strong> <code>cassandra::java_gc</code> and the class <code>cassandra::java::gc</code> are now deprecated. Consider using JVM option sets instead.</p>

<p>Settings to Java garbage collector can be made by instanciating the <code>cassandra::java::gc</code> class. Using the <code>java_gc</code> parameter will instantiate the class, e.g.:</p>

<pre class="code ruby"><code class="ruby">cassandra::java_gc:
  collector: g1
  params:
    maxGCPauseMillis: 300
</code></pre>

<h3 id="label-JVM+option+sets">JVM option sets</h3>

<p>Since version 2.2 the module is supporting a novel approach to setup options of Cassandra Java runtime. The JVM option set feature is controlling the <code>jvm.options</code> file of Cassandra 3.x and many combinations used for different Java versions and use case scopes by Cassandra 4.0 and later.</p>

<p><strong>Note</strong>, that much of these settings will override settings done with <code>cassandra::java</code> and all of this will collide with <code>cassandra::java_gc</code> if set. Thus remove <code>cassandra::java_gc</code> at all when starting with <code>cassandra::jvm_option_sets</code> and consider migrating <code>cassandra::java</code> settings to <code>cassandra::jvm_options</code>.</p>

<h4 id="label-JVM+options+for+Cassandra+3.x">JVM options for Cassandra 3.x</h4>

<p>Default behaviour will control the <code>jvm.options</code> file. The defined type <code>cassandra::jvm_option_set</code> resource take parameters <code>options</code>, <code>sizeoptions</code>, <code>properties</code> and <code>advancedoptions</code> and add the settings to the <code>jvm.options</code> file.</p>

<p>Use the <code>cassandra::jvm_option_sets</code> parameter to build instances of <code>cassandra::jvm_option_set</code> type. For example:</p>

<pre class="code ruby"><code class="ruby">cassandra::jvm_option_sets:
  example:
    options:
      - ea
      - server
    sizeoptions:
      Xms: 4G
      Xmx: 4G
      Xmn: 800M
    advancedoptions:
      LargePageSizeInBytes: 2m
      UseLargePages: true
      AlwaysPreTouch: true
    properties:
      cassandra.start_rpc: false
</code></pre>

<p>For all options, advanced runtime options and properties in the above example, the Puppet module will take control over the according lines in the <code>jvm.options</code> file only and set the desired options. Many other settings within <code>jvm.options</code> will not be touched by Puppet.</p>

<p>The top level ID (<code>example</code>) is the name of the option set allowing the grouping of options. Multiple option sets are allowed, however, it is not allowed to set the same option within different option sets.</p>

<p>In order to enable the removal of specific settings from <code>jvm.options</code>, use a tilde <code>~</code> to prefix options, and undef value (denoted with tilde <code>~</code> in Hiera) of <code>properties</code>, <code>sizeoptions</code> and <code>advancedoptions</code>. The example below show how to remove specific settings.</p>

<pre class="code ruby"><code class="ruby">cassandra::jvm_option_sets:
  remove:
    options:
      - ~ea
    sizeoptions:
      Xmn: ~
    advancedoptions:
      FlightRecorder: ~
    properties:
      cassandra.initial_token: ~
</code></pre>

<h4 id="label-Cassandra+4.0+and+later+JVM+setup">Cassandra 4.0 and later JVM setup</h4>

<p>Cassandra 4.0 and later are using distinct option files for server operation and client tools, for Java version independent options and for different Java versions. Set the parameters <code>optsfile</code> to <code>jvm</code>, <code>jvm8</code>, <code>jvm11</code> or <code>jvm17</code> and <code>variant</code> to <code>server</code> or <code>clients</code> accordingly.</p>

<pre class="code ruby"><code class="ruby">cassandra::jvm_option_sets:
  java8example:
    optsfile: jvm8
    variant: server
    advancedoptions:
      ThreadPriorityPolicy: 42
  java11example:
    optsfile: jvm11
    variant: server
    advancedoptions:
      UseConcMarkSweepGC: false
      CMSParallelRemarkEnabled: ~
      UnlockExperimentalVMOptions: true
      UseZGC: true
</code></pre>

<h2 id="label-Reference">Reference</h2>

<p>Automatically generated reference documentation is available in the <a href="https://forge.puppet.com/modules/trepasi/cassandra/reference">REFERENCE.md</a> file or at <a href="https://rtib.github.io/puppet-cassandra/">rtib.github.io/puppet-cassandra/</a>.</p>

<h2 id="label-Limitations">Limitations</h2>

<p>For supported operating systems and dependencies, see <a href="https://github.com/rtib/puppet-cassandra/blob/main/metadata.json">metadata.json</a>.</p>

<p>Extensive itegration tests are run nightly to assure quality and compatibility with next releases.</p>

<p>The current integration test matrix:</p>

<table role="table">
<thead>
<tr>
<th>Cassandra branch</th>
<th>OS distro</th>
<th><a href="&lt;sup&gt;1&lt;/sup&gt;">JDK</a>(#java)</th>
</tr>
</thead>
<tbody>
<tr>
<td>3.0</td>
<td>Debian:9<br>Ubuntu:16.04<br>Ubuntu:18.04</td>
<td>OpenJDK-8</td>
</tr>
<tr>
<td>3.11</td>
<td>Debian:9<br>Ubuntu:16.04<br>Ubuntu:18.04</td>
<td>OpenJDK-8</td>
</tr>
<tr>
<td>4.0</td>
<td>Debian:9<br>Debian:10<br>Ubuntu:16.04<br>Ubuntu:18.04</td>
<td>OpenJDK-8<br>OpenJDK-11<br>OpenJDK-8<br>OpenJDK-8<br></td>
</tr>
</tbody>
</table>

<p>&lt;a class=“anchor” id=“java”&gt;1&lt;/a&gt;: Note, that this module will not manage any JDK installation. The JDK versions listed here are automatically installed via dependencies while the module is installing the latest available Cassandra version from the release branch.</p>

<h2 id="label-Development">Development</h2>

<p>The module is developed using recent <a href="https://puppet.com/docs/pdk/2.x/pdk.html">Puppet Development Kit</a>, <a href="https://puppet.com/docs/pdk/1.x/pdk_testing.html">validated</a> and extensively tested using <a href="https://github.com/puppetlabs/puppet_litmus">Puppet Litmus</a>. Automated workflows, implemented with <a href="https://docs.github.com/en/actions">GitHub Actions</a> are run on demand and nightly, doing validation, spec tests and continuous integration tests.</p>

<p>As an open project, you are welcome to contribute to this module. Currently, there is no contribution guide specific to this module, general information about the workflow may apply. In case of questions feel free to open a issue or join community Slack channels #forge-modules, #puppet, #puppet-dev, #testing on slack.puppet.com.</p>

<p>Issues and pull requests will be addressed in a timely manner, according to community best practice. Releases are going to be published on demand, after having merged an set of sufficiently important changes and all tests succeeded. There may be automated rule enforcement in place to provide a healthy issue lifecycle.</p>
</div></div>

      <div id="footer">
     Generated by <a href="http://yardoc.org" title="Yay! A Ruby Documentation Tool" target="_parent">yard</a>.
</div>

    </div>
  </body>
</html>